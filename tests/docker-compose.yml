version: "3.1"

volumes:
  data-solr:

services:

  solr:
    container_name: "solr"
    image: "solr:latest"
    expose:
      - "8983"
    ports:
      - "8983:8983"
    volumes:
      - "data-solr:/var/solr"
    healthcheck:
      test: [ "CMD-SHELL", "curl http://localhost:8983/solr" ]
      interval: 5s
      timeout: 5s
      retries: 10
    command:
      - "solr-precreate"
      - "solr-geonames"

  nginx:
    container_name: "nginx"
    image: "nginx:latest"
    expose:
      - "8080"
    ports:
      - "8080:8080"
    depends_on:
      - "solr"

  solr-geonames:
    container_name: "solr-geonames"
    image: "qcifengineering/solr-geonames-indexer:local"
    volumes:
      - "./:/opt/data:ro"
    command:
      - node
      - index.js
      - --core
      - solr-geonames
      - --file
      - /opt/data/SM.txt
      - --solrUrl
      - http://solr:8983/solr
    depends_on:
      solr:
        condition: service_healthy
      nginx:
        condition: service_started
